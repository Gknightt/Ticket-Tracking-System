# ============================================================================
# PRODUCTION DOCKER COMPOSE CONFIGURATION
# Single DigitalOcean Droplet Deployment
# ============================================================================
# Usage: docker-compose -f docker-compose.prod.yml up -d
# 
# Architecture:
#   - Single VM with Docker Engine
#   - PostgreSQL 15 (persistent volume)
#   - RabbitMQ (persistent volume)
#   - 5 Django microservices + workers
#   - React frontend served via Nginx
#   - Nginx reverse proxy with SSL termination
#   - All services on internal network (no direct port exposure except Nginx)
# ============================================================================

version: '3.8'

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local
  media_files:
    driver: local
  nginx_logs:
    driver: local

services:
  # ========== INFRASTRUCTURE SERVICES ==========
  
  # PostgreSQL 15 - Single instance, multiple logical databases
  db:
    image: postgres:15-alpine
    container_name: tts-postgres
    restart: always
    networks:
      - app-network
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_DB: postgres
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "127.0.0.1:5432:5432"  # Only accessible from localhost (no external exposure)
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db-init:/docker-entrypoint-initdb.d
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # RabbitMQ 3.13 - Message broker with management UI
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: tts-rabbitmq
    restart: always
    networks:
      - app-network
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
      RABBITMQ_DEFAULT_VHOST: /
    ports:
      - "127.0.0.1:5672:5672"    # AMQP - only from localhost
      - "127.0.0.1:15672:15672"  # Management UI - only from localhost
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ========== DJANGO BACKEND SERVICES ==========

  # Auth Service - User management, roles, permissions
  auth-service:
    image: tts/auth:latest
    build:
      context: ../auth
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-auth
    restart: always
    networks:
      - app-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_JWT_SIGNING_KEY: ${DJANGO_JWT_SIGNING_KEY}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_CORS_ALLOWED_ORIGINS: ${DJANGO_CORS_ALLOWED_ORIGINS}
      DJANGO_CSRF_TRUSTED_ORIGINS: ${DJANGO_CSRF_TRUSTED_ORIGINS}
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-changeme}@db:5432/auth_db
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_EMAIL_BACKEND: ${DJANGO_EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
      DJANGO_EMAIL_HOST: ${DJANGO_EMAIL_HOST}
      DJANGO_EMAIL_PORT: ${DJANGO_EMAIL_PORT:-587}
      DJANGO_EMAIL_HOST_USER: ${DJANGO_EMAIL_HOST_USER}
      DJANGO_EMAIL_HOST_PASSWORD: ${DJANGO_EMAIL_HOST_PASSWORD}
      DJANGO_EMAIL_USE_TLS: "True"
      DJANGO_DEFAULT_FROM_EMAIL: ${DJANGO_DEFAULT_FROM_EMAIL}
      TTS_SYSTEM_URL: ${TTS_SYSTEM_URL}
      AMS_SYSTEM_URL: ${AMS_SYSTEM_URL}
      HDTS_SYSTEM_URL: ${HDTS_SYSTEM_URL}
      BMS_SYSTEM_URL: ${BMS_SYSTEM_URL}
      DEFAULT_SYSTEM_URL: ${DEFAULT_SYSTEM_URL}
      FRONTEND_URL: ${FRONTEND_URL}
    expose:
      - "8000"
    volumes:
      - ./logs/auth:/app/logs
      - media_files:/app/media
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Ticket Service - Ticket CRUD and file handling
  ticket-service:
    image: tts/ticket-service:latest
    build:
      context: ../ticket_service
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-ticket
    restart: always
    networks:
      - app-network
    depends_on:
      auth-service:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_CORS_ALLOWED_ORIGINS: ${DJANGO_CORS_ALLOWED_ORIGINS}
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-changeme}@db:5432/ticket_db
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      CELERY_TASK_DEFAULT_QUEUE: TICKET_TASKS_PRODUCTION
      DJANGO_AUTH_SERVICE_URL: http://auth-service:8000
      DJANGO_WORKFLOW_API_URL: http://workflow-api:8000
    expose:
      - "8000"
    volumes:
      - ./logs/ticket:/app/logs
      - media_files:/app/media
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Workflow API - Workflow orchestration and execution
  workflow-api:
    image: tts/workflow-api:latest
    build:
      context: ../workflow_api
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-workflow-api
    restart: always
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_JWT_SIGNING_KEY: ${DJANGO_JWT_SIGNING_KEY}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_CORS_ALLOWED_ORIGINS: ${DJANGO_CORS_ALLOWED_ORIGINS}
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-changeme}@db:5432/workflow_db
      DJANGO_CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_NOTIFICATION_SERVICE_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_NOTIFICATION_QUEUE: notification-queue
      DJANGO_TICKET_STATUS_QUEUE: ticket_status
      DJANGO_INAPP_NOTIFICATION_QUEUE: inapp-notification-queue
      DJANGO_AUTH_SERVICE_URL: http://auth-service:8000
      DJANGO_NOTIFICATION_SERVICE_URL: http://notification-service:8001
      DJANGO_TTS_SERVICE_URL: http://workflow-api:8000
      DJANGO_BASE_URL: ${DJANGO_BASE_URL}
      DJANGO_FRONTEND_URL: ${DJANGO_FRONTEND_URL}
    expose:
      - "8000"
    volumes:
      - ./logs/workflow:/app/logs
      - media_files:/app/media
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Messaging Service - WebSocket comments and real-time messaging
  messaging-service:
    image: tts/messaging:latest
    build:
      context: ../messaging
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-messaging
    restart: always
    networks:
      - app-network
    depends_on:
      auth-service:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_JWT_SIGNING_KEY: ${DJANGO_JWT_SIGNING_KEY}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_CORS_ALLOWED_ORIGINS: ${DJANGO_CORS_ALLOWED_ORIGINS}
      DJANGO_CORS_ALLOW_CREDENTIALS: "True"
      DJANGO_MEDIA_BASE_URL: ${DJANGO_MEDIA_BASE_URL}
    expose:
      - "8001"
    volumes:
      - ./logs/messaging:/app/logs
      - media_files:/app/media
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Notification Service - Async notification delivery
  notification-service:
    image: tts/notification:latest
    build:
      context: ../notification_service
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-notification
    restart: always
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_JWT_SIGNING_KEY: ${DJANGO_JWT_SIGNING_KEY}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS}
      DJANGO_CORS_ALLOWED_ORIGINS: ${DJANGO_CORS_ALLOWED_ORIGINS}
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-changeme}@db:5432/notification_db
      DJANGO_CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_NOTIFICATION_QUEUE: notification-queue
      DJANGO_INAPP_NOTIFICATION_QUEUE: inapp-notification-queue
      DJANGO_EMAIL_BACKEND: ${DJANGO_EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
      DJANGO_EMAIL_HOST: ${DJANGO_EMAIL_HOST}
      DJANGO_EMAIL_PORT: ${DJANGO_EMAIL_PORT:-587}
      DJANGO_EMAIL_HOST_USER: ${DJANGO_EMAIL_HOST_USER}
      DJANGO_EMAIL_HOST_PASSWORD: ${DJANGO_EMAIL_HOST_PASSWORD}
      DJANGO_EMAIL_USE_TLS: "True"
      DJANGO_DEFAULT_FROM_EMAIL: ${DJANGO_DEFAULT_FROM_EMAIL}
      DJANGO_AUTH_SERVICE_URL: http://auth-service:8000
    expose:
      - "8001"
    volumes:
      - ./logs/notification:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ========== CELERY WORKERS ==========

  # Workflow Worker - Processes workflow-related tasks
  workflow-worker:
    image: tts/workflow-api:latest
    build:
      context: ../workflow_api
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-workflow-worker
    restart: always
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_JWT_SIGNING_KEY: ${DJANGO_JWT_SIGNING_KEY}
      DJANGO_ALLOWED_HOSTS: localhost,127.0.0.1,workflow-worker
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-changeme}@db:5432/workflow_db
      DJANGO_CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_NOTIFICATION_SERVICE_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_AUTH_SERVICE_URL: http://auth-service:8000
      DJANGO_NOTIFICATION_SERVICE_URL: http://notification-service:8001
      C_FORCE_ROOT: "false"
    command: >
      sh -c "celery -A workflow_api worker 
             --pool=prefork 
             --concurrency=4 
             --loglevel=info 
             -Q role_send-default,TICKET_TASKS_PRODUCTION,tts.role.sync,tts.user_system_role.sync,workflow_seed_queue,workflow_seed
             --logfile=/var/log/celery/workflow-worker.log"
    volumes:
      - ./logs/celery:/var/log/celery
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Notification Worker - Processes notification delivery tasks
  notification-worker:
    image: tts/notification:latest
    build:
      context: ../notification_service
      dockerfile: Dockerfile.prod
      args:
        PYTHON_VERSION: 3.11
    container_name: tts-notification-worker
    restart: always
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      notification-service:
        condition: service_healthy
    environment:
      DJANGO_ENV: production
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
      DJANGO_JWT_SIGNING_KEY: ${DJANGO_JWT_SIGNING_KEY}
      DJANGO_ALLOWED_HOSTS: localhost,127.0.0.1,notification-worker
      DATABASE_URL: postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-changeme}@db:5432/notification_db
      DJANGO_CELERY_BROKER_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-changeme}@rabbitmq:5672/
      DJANGO_NOTIFICATION_QUEUE: notification-queue
      DJANGO_INAPP_NOTIFICATION_QUEUE: inapp-notification-queue
      DJANGO_AUTH_SERVICE_URL: http://auth-service:8000
    command: >
      sh -c "celery -A notification_service worker 
             --pool=prefork 
             --concurrency=2 
             --loglevel=info 
             -Q notification-queue,inapp-notification-queue
             --logfile=/var/log/celery/notification-worker.log"
    volumes:
      - ./logs/celery:/var/log/celery
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ========== FRONTEND & REVERSE PROXY ==========

  # React Frontend - Static build served by Nginx
  frontend:
    image: tts/frontend:latest
    build:
      context: ../frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_AUTH_URL: ${VITE_AUTH_URL}
        VITE_WORKFLOW_API: ${VITE_WORKFLOW_API}
        VITE_BACKEND_API: ${VITE_BACKEND_API}
    container_name: tts-frontend
    restart: always
    networks:
      - app-network
    expose:
      - "1000"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Reverse Proxy - SSL termination, routing, load balancing
  nginx:
    image: nginx:1.25-alpine
    container_name: tts-nginx
    restart: always
    networks:
      - app-network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - media_files:/app/media:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - frontend
      - auth-service
      - ticket-service
      - workflow-api
      - messaging-service
      - notification-service
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
