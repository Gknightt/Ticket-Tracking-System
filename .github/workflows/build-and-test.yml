name: Build and Test

on:
  push:
    branches: [ main, QA, develop ]
  pull_request:
    branches: [ main, QA, develop ]

jobs:
  build-docker:
    name: Build Docker Services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all Docker services
        working-directory: Docker
        run: |
          docker compose build --no-cache

      - name: Verify Docker images were created
        run: |
          docker images | grep -E "auth-service|ticket-service|workflow-api|messaging-service|notification-service|nginx"

  auth-service-tests:
    name: Auth Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: auth
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-auth-${{ hashFiles('auth/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-auth-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Collect static files
        run: |
          python manage.py collectstatic --noinput --clear || true

      - name: Run auth service tests
        run: |
          python manage.py test --verbosity=2
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-service-test-results
          path: auth/test-results/
          retention-days: 7

  workflow-api-tests:
    name: Workflow API Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: workflow_api
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-workflow-${{ hashFiles('workflow_api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-workflow-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Collect static files
        run: |
          python manage.py collectstatic --noinput --clear || true

      - name: Run Roles Management Tests
        run: |
          python manage.py test tests.test_roles_management --verbosity=2
        continue-on-error: false

      - name: Run Workflow Creation Tests
        run: |
          python manage.py test tests.test_workflow_creation --verbosity=2
        continue-on-error: false

      - name: Run Workflow Editing Tests
        run: |
          python manage.py test tests.test_workflow_editing --verbosity=2
        continue-on-error: false

      - name: Run Workflow Graph Tests
        run: |
          python manage.py test tests.test_workflow_graph --verbosity=2
        continue-on-error: false

      - name: Run Steps & Transitions Tests
        run: |
          python manage.py test tests.test_steps_transitions --verbosity=2
        continue-on-error: false

      - name: Run Ticket Generation Tests
        run: |
          python manage.py test tests.test_ticket_generation --verbosity=2
        continue-on-error: false

      - name: Run Task Assignment Tests
        run: |
          python manage.py test tests.test_task_assignment --verbosity=2
        continue-on-error: false

      - name: Run API Endpoints Tests
        run: |
          python manage.py test tests.test_api_endpoints --verbosity=2
        continue-on-error: false

      - name: Run workflow audit logging tests
        # Note: This test uses Django shell and may have external dependencies
        # Set to continue-on-error to not block the build
        run: |
          python manage.py shell < test_audit_logging.py 2>&1
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-api-test-results
          path: workflow_api/test-results/
          retention-days: 7

  ticket-service-tests:
    name: Ticket Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ticket_service
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ticket-${{ hashFiles('ticket_service/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-ticket-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ../requirements.txt

      - name: Collect static files
        run: |
          python manage.py collectstatic --noinput --clear || true

      - name: Run ticket service tests
        run: |
          python manage.py test --verbosity=2
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ticket-service-test-results
          path: ticket_service/test-results/
          retention-days: 7

  messaging-service-tests:
    name: Messaging Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: messaging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-messaging-${{ hashFiles('messaging/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-messaging-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run websocket tests
        run: |
          python test_websocket_comments.py 2>&1
        continue-on-error: true

      - name: Run messaging tests
        run: |
          python manage.py test --verbosity=2
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: messaging-service-test-results
          path: messaging/test-results/
          retention-days: 7

  notification-service-tests:
    name: Notification Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: notification_service
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-notification-${{ hashFiles('notification_service/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-notification-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run notification queue tests
        run: |
          python test_notification_queue.py 2>&1
        continue-on-error: true

      - name: Run notification service tests
        run: |
          python manage.py test --verbosity=2
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notification-service-test-results
          path: notification_service/test-results/
          retention-days: 7

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Build frontend
        run: npm run build

      - name: Verify build output
        run: |
          if [ -d "dist" ]; then
            echo "Build successful - dist directory created"
            ls -la dist/
          else
            echo "Build failed - dist directory not found"
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7

  integration-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest
    needs: [build-docker]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        working-directory: Docker
        run: |
          docker compose build

      - name: Start services
        working-directory: Docker
        run: |
          docker compose up -d
          sleep 30

      - name: Check service health
        run: |
          echo "Checking PostgreSQL..."
          docker exec postgres_db pg_isready -U postgres || echo "PostgreSQL check failed"
          
          echo "Checking RabbitMQ..."
          docker exec rabbitmq rabbitmq-diagnostics ping || echo "RabbitMQ check failed"
          
          echo "Checking Nginx..."
          docker logs nginx-proxy || echo "Nginx check failed"

      - name: Test API endpoints
        run: |
          sleep 10
          
          echo "Testing Nginx health endpoint..."
          curl -f http://localhost:8080/health || echo "Health check failed"
          
          echo "API endpoint checks completed"

      - name: View service logs
        if: always()
        working-directory: Docker
        run: |
          echo "=== Auth Service Logs ==="
          docker logs auth-service 2>&1 | tail -20 || true
          
          echo "=== Ticket Service Logs ==="
          docker logs ticket-service 2>&1 | tail -20 || true
          
          echo "=== Workflow API Logs ==="
          docker logs workflow-api 2>&1 | tail -20 || true
          
          echo "=== Workflow Worker Logs ==="
          docker logs workflow-worker 2>&1 | tail -20 || true
          
          echo "=== Nginx Logs ==="
          docker logs nginx-proxy 2>&1 | tail -20 || true

      - name: Stop services
        if: always()
        working-directory: Docker
        run: |
          docker compose down -v

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [
      build-docker,
      auth-service-tests,
      workflow-api-tests,
      ticket-service-tests,
      messaging-service-tests,
      notification-service-tests,
      frontend-build,
      integration-test
    ]
    if: always()
    steps:
      - name: Print test results
        run: |
          echo "Build and Test Workflow Summary"
          echo "================================"
          echo "Docker Build: ${{ needs.build-docker.result }}"
          echo "Auth Service Tests: ${{ needs.auth-service-tests.result }}"
          echo "Workflow API Tests: ${{ needs.workflow-api-tests.result }}"
          echo "Ticket Service Tests: ${{ needs.ticket-service-tests.result }}"
          echo "Messaging Service Tests: ${{ needs.messaging-service-tests.result }}"
          echo "Notification Service Tests: ${{ needs.notification-service-tests.result }}"
          echo "Frontend Build: ${{ needs.frontend-build.result }}"
          echo "Integration Test: ${{ needs.integration-test.result }}"

      - name: Check for failures
        run: |
          if [[ "${{ needs.build-docker.result }}" == "failure" ]] || \
             [[ "${{ needs.auth-service-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.workflow-api-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.ticket-service-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.messaging-service-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.notification-service-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-build.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-test.result }}" == "failure" ]]; then
            echo "❌ One or more test jobs failed!"
            exit 1
          else
            echo "✅ All tests passed successfully!"
          fi
