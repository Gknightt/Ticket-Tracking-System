## reCAPTCHA v3 - Token Verification Failure Analysis

### Current Status: ❌ Tokens Being Rejected

**Server Log:** `reCAPTCHA verification failed.` (HTTP 400)

**Root Cause:** The reCAPTCHA tokens generated by the browser are being rejected by Google's verification API with error: `invalid-input-response`

This indicates one of these issues:

---

## Issue 1: Domain/Hostname Mismatch (MOST LIKELY)

**What's happening:**
1. You're accessing login page from: `http://localhost:8003` (or similar)
2. Browser sends reCAPTCHA token with that hostname embedded
3. Google reCAPTCHA keys are registered for a DIFFERENT domain
4. Google API rejects token because hostname doesn't match

**Solution:**
Go to [Google reCAPTCHA Console](https://www.google.com/recaptcha/admin):

1. Select your site with keys: `6LecFiMsAAAAALqTi3ju...`
2. Go to **Settings** tab
3. Under **Domains**, you should see what domain the keys are registered for
4. **Add** the domain/port you're accessing from:
   - If accessing as `http://localhost:8003` → Add `localhost`
   - If accessing as `http://127.0.0.1:8003` → Add `127.0.0.1`
   - If accessing from a hostname → Add that hostname

**Step-by-step:**
1. Visit: https://www.google.com/recaptcha/admin
2. Click on your site
3. Click **Settings**
4. Scroll to **Domains**
5. Click **+ Add domain**
6. Enter: `localhost` (or whatever you're accessing from)
7. Save

---

## Issue 2: Token Expiration

**What's happening:**
- reCAPTCHA v3 tokens expire quickly (usually 2-3 minutes)
- If there's network delay between token generation and API call, it might expire

**Solution:**
- Ensure you're testing immediately after clicking "Log In"
- Don't wait between token generation and submission

---

## Issue 3: Keys Are for v2, Not v3

**Verification:**
Run this to check what your keys are:
```bash
cd auth2
python -c "from django.conf import settings; import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'auth.settings'); print('Site Key:', settings.RECAPTCHA_SITE_KEY); print('Secret Key:', settings.RECAPTCHA_SECRET_KEY)"
```

These keys SHOULD be v3 keys (they look similar to v2 but behave differently).

---

## Diagnostic Steps

### Step 1: Identify Your Access Domain
Open login page and check URL bar. What do you see?
- `http://localhost:8003/api/v1/users/login/` → Domain is `localhost`
- `http://127.0.0.1:8003/api/v1/users/login/` → Domain is `127.0.0.1`
- `http://192.168.1.100:8003/api/v1/users/login/` → Domain is `192.168.1.100`

**Write down your domain/IP:**  `_______________`

### Step 2: Check reCAPTCHA Console Settings

1. Go to https://www.google.com/recaptcha/admin
2. Select your site (with site key `6LecFiMsAAAAALqTi3ju...`)
3. Check: **Settings** → **Domains** section
4. **Write down all domains listed:** 

   ```
   - _______________
   - _______________
   - _______________
   ```

### Step 3: Compare

- If your access domain (Step 1) is NOT in the reCAPTCHA console domains list (Step 2) → **ADD IT**
- If it is listed → Continue to Step 4

### Step 4: Test Again

After adding domain:
1. Wait 1-2 minutes for change to propagate
2. Try login again
3. Check server logs for: `reCAPTCHA v3 verification - success: True`

---

## Immediate Test Command

To test directly with enhanced logging:

```bash
cd "C:\work\Capstone 2\Group5Capstone1\auth2"
python test_recaptcha_token_diagnostic.py
```

This will:
1. Show your current reCAPTCHA configuration
2. Ask you to enter a token from browser console
3. Test it with Google API
4. Show detailed error codes

**How to get a token:**
1. Open login page in browser
2. Press F12 (DevTools)
3. Go to Console tab
4. Paste this command:
   ```javascript
   grecaptcha.execute('6LecFiMsAAAAALqTi3jugBmMY29ZCDtTRB-xmNGv', {action: 'test'})
     .then(token => {
       console.log('YOUR TOKEN:');
       console.log(token);
     })
   ```
5. Copy the very long token from console
6. Paste into diagnostic script

---

## Current Implementation Status

✅ **Backend:** reCAPTCHA verification IS working (correctly rejecting invalid tokens)
✅ **Frontend:** Token is being generated and sent to API
✅ **Logging:** Enhanced logging added to show exact error codes
❌ **Token Validation:** Tokens being rejected (likely domain issue)

---

## Next Action

**Most Likely Fix:**
1. Visit Google reCAPTCHA Console
2. Add your access domain to the Domains list
3. Wait 1-2 minutes
4. Test login again

**Alternative:** Get a test token and run diagnostic script to confirm exact error.
