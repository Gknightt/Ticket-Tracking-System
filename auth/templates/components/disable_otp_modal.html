<!-- Modal for OTP Disable Verification -->
<div id="disable-otp-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Disable Two-Factor Authentication</h3>
            <button type="button" class="modal-close" id="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 20px; color: #666;">
                For security purposes, please verify your identity before disabling 2FA.
            </p>
            <div id="otp-request-info" class="info-message" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <p style="margin: 0; color: #1976d2; font-size: 14px;">
                    üìß An OTP code has been sent to your email. Please check your inbox.
                </p>
            </div>
            <div class="formGroup">
                <label for="verify-password">Password</label>
                <input type="password" id="verify-password" class="form-control" placeholder="Enter your password" required>
                <small class="error-message" id="password-error"></small>
            </div>
            <div class="formGroup">
                <label for="verify-otp">OTP Code</label>
                <input type="text" id="verify-otp" class="form-control" placeholder="Enter your OTP code" maxlength="6" required>
                <small class="error-message" id="otp-error"></small>
                <small style="color: #666;">Enter the 6-digit code sent to your email.</small>
            </div>
            <div id="verification-general-error" class="error-message" style="margin-top: 10px;"></div>
            <div style="margin-top: 15px;">
                <button type="button" id="resend-otp-btn" class="resend-otp-btn" style="background: none; border: none; color: #1976d2; cursor: pointer; text-decoration: underline; font-size: 14px;">
                    Didn't receive the code? Resend OTP
                </button>
                <span id="resend-timer" style="color: #666; font-size: 14px; margin-left: 10px; display: none;"></span>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="cancelChangesBtn" id="modal-cancel-btn">Cancel</button>
            <button type="button" class="saveChangesBtn" id="modal-verify-btn">Verify & Disable</button>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #333;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 1;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .error-message {
        display: block;
        color: #d32f2f;
        font-size: 12px;
        margin-top: 5px;
    }

    .error-message:empty {
        display: none;
    }

    .info-message {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .info-message p {
        margin: 0;
        color: #1976d2;
        font-size: 14px;
    }

    .resend-otp-btn {
        background: none;
        border: none;
        color: #1976d2;
        cursor: pointer;
        text-decoration: underline;
        font-size: 14px;
        padding: 0;
    }

    .resend-otp-btn:hover:not(:disabled) {
        color: #1565c0;
    }

    .resend-otp-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<script>
    // OTP Disable Verification Modal Handler
    document.addEventListener("DOMContentLoaded", function () {
        const otpCheckbox = document.getElementById("id_otp_enabled");
        const modal = document.getElementById("disable-otp-modal");
        const modalCloseBtn = document.getElementById("modal-close-btn");
        const modalCancelBtn = document.getElementById("modal-cancel-btn");
        const modalVerifyBtn = document.getElementById("modal-verify-btn");
        const verifyPasswordInput = document.getElementById("verify-password");
        const verifyOtpInput = document.getElementById("verify-otp");
        const passwordError = document.getElementById("password-error");
        const otpError = document.getElementById("otp-error");
        const generalError = document.getElementById("verification-general-error");
        const resendOtpBtn = document.getElementById("resend-otp-btn");
        const resendTimer = document.getElementById("resend-timer");
        const otpRequestInfo = document.getElementById("otp-request-info");

        let originalOtpState = otpCheckbox ? otpCheckbox.checked : false;
        let isVerificationPending = false;
        let resendCooldown = 0;
        let resendInterval = null;

        // Track original state when page loads
        if (otpCheckbox) {
            originalOtpState = otpCheckbox.checked;
        }

        // Function to request OTP
        async function requestOTP() {
            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const response = await fetch("/api/v1/users/2fa/request-otp-authenticated/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    credentials: "include",
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (response.ok) {
                    otpRequestInfo.style.display = "block";
                    otpRequestInfo.innerHTML = '<p style="margin: 0; color: #1976d2; font-size: 14px;">‚úÖ OTP code sent successfully! Check your email.</p>';
                    
                    // Start resend cooldown
                    startResendCooldown();
                } else {
                    otpRequestInfo.style.display = "block";
                    otpRequestInfo.style.background = "#ffebee";
                    otpRequestInfo.innerHTML = '<p style="margin: 0; color: #c62828; font-size: 14px;">‚ö†Ô∏è Failed to send OTP. Please try again.</p>';
                }
            } catch (error) {
                console.error("Error requesting OTP:", error);
                otpRequestInfo.style.display = "block";
                otpRequestInfo.style.background = "#ffebee";
                otpRequestInfo.innerHTML = '<p style="margin: 0; color: #c62828; font-size: 14px;">‚ö†Ô∏è Network error. Please try again.</p>';
            }
        }

        // Start resend cooldown timer
        function startResendCooldown() {
            resendCooldown = 60; // 60 seconds cooldown
            resendOtpBtn.disabled = true;
            resendOtpBtn.style.opacity = "0.5";
            resendOtpBtn.style.cursor = "not-allowed";
            resendTimer.style.display = "inline";
            
            if (resendInterval) clearInterval(resendInterval);
            
            resendInterval = setInterval(() => {
                resendCooldown--;
                resendTimer.textContent = `(Wait ${resendCooldown}s)`;
                
                if (resendCooldown <= 0) {
                    clearInterval(resendInterval);
                    resendOtpBtn.disabled = false;
                    resendOtpBtn.style.opacity = "1";
                    resendOtpBtn.style.cursor = "pointer";
                    resendTimer.style.display = "none";
                }
            }, 1000);
        }

        // Resend OTP button handler
        if (resendOtpBtn) {
            resendOtpBtn.addEventListener("click", async function() {
                if (resendCooldown > 0) return;
                await requestOTP();
            });
        }

        // Intercept OTP checkbox changes
        if (otpCheckbox) {
            otpCheckbox.addEventListener("change", async function(e) {
                // If OTP is being disabled (was checked, now unchecked)
                if (originalOtpState && !this.checked) {
                    e.preventDefault();
                    this.checked = true; // Keep it checked
                    isVerificationPending = true;
                    
                    // Clear previous errors and inputs
                    passwordError.textContent = "";
                    otpError.textContent = "";
                    generalError.textContent = "";
                    verifyPasswordInput.value = "";
                    verifyOtpInput.value = "";
                    otpRequestInfo.style.display = "none";
                    otpRequestInfo.style.background = "#e3f2fd";
                    
                    // Show modal
                    modal.style.display = "flex";
                    
                    // Automatically request OTP when modal opens
                    await requestOTP();
                    
                    verifyPasswordInput.focus();
                } else if (!originalOtpState && this.checked) {
                    // Enabling OTP - allow it normally
                    isVerificationPending = false;
                }
            });
        }

        // Close modal handlers
        function closeModal() {
            modal.style.display = "none";
            isVerificationPending = false;
            if (otpCheckbox) {
                otpCheckbox.checked = true; // Reset to checked state
            }
            // Clear cooldown timer
            if (resendInterval) {
                clearInterval(resendInterval);
                resendInterval = null;
            }
            resendCooldown = 0;
            resendTimer.style.display = "none";
            resendOtpBtn.disabled = false;
            resendOtpBtn.style.opacity = "1";
            resendOtpBtn.style.cursor = "pointer";
        }

        if (modalCloseBtn) {
            modalCloseBtn.addEventListener("click", closeModal);
        }

        if (modalCancelBtn) {
            modalCancelBtn.addEventListener("click", closeModal);
        }

        // Click outside modal to close
        modal.addEventListener("click", function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Verify and disable OTP
        if (modalVerifyBtn) {
            modalVerifyBtn.addEventListener("click", async function() {
                const password = verifyPasswordInput.value.trim();
                const otp = verifyOtpInput.value.trim();

                // Clear previous errors
                passwordError.textContent = "";
                otpError.textContent = "";
                generalError.textContent = "";

                // Validate inputs
                let hasError = false;
                if (!password) {
                    passwordError.textContent = "Password is required";
                    hasError = true;
                }
                if (!otp) {
                    otpError.textContent = "OTP code is required";
                    hasError = true;
                }
                if (otp && otp.length !== 6) {
                    otpError.textContent = "OTP must be 6 digits";
                    hasError = true;
                }

                if (hasError) return;

                // Disable button during request
                modalVerifyBtn.disabled = true;
                modalVerifyBtn.textContent = "Verifying...";

                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // Send verification request
                    const response = await fetch("/api/v1/users/verify-disable-otp/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                        credentials: "include",
                        body: JSON.stringify({
                            password: password,
                            otp_code: otp
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Verification successful - allow OTP to be disabled
                        originalOtpState = false;
                        if (otpCheckbox) {
                            otpCheckbox.checked = false;
                        }
                        isVerificationPending = false;
                        closeModal();
                        
                        // Show success message
                        const toastContainer = document.querySelector(".toastContainer");
                        if (toastContainer) {
                            const toast = document.createElement("div");
                            toast.className = "toast success";
                            toast.textContent = "Verification successful. You can now save your changes.";
                            toastContainer.appendChild(toast);
                            setTimeout(() => toast.classList.add("hide"), 3500);
                        }
                    } else {
                        // Show error
                        if (data.password) {
                            passwordError.textContent = Array.isArray(data.password) ? data.password.join(", ") : data.password;
                        }
                        if (data.otp_code) {
                            otpError.textContent = Array.isArray(data.otp_code) ? data.otp_code.join(", ") : data.otp_code;
                        }
                        if (data.detail || data.error) {
                            generalError.textContent = data.detail || data.error;
                        }
                        if (data.non_field_errors) {
                            generalError.textContent = Array.isArray(data.non_field_errors) ? data.non_field_errors.join(", ") : data.non_field_errors;
                        }
                        if (!data.password && !data.otp_code && !data.detail && !data.error && !data.non_field_errors) {
                            generalError.textContent = "Verification failed. Please check your credentials.";
                        }
                    }
                } catch (error) {
                    console.error("Verification error:", error);
                    generalError.textContent = "An error occurred. Please try again.";
                } finally {
                    // Re-enable button
                    modalVerifyBtn.disabled = false;
                    modalVerifyBtn.textContent = "Verify & Disable";
                }
            });
        }

        // Handle Enter key in inputs
        [verifyPasswordInput, verifyOtpInput].forEach(input => {
            if (input) {
                input.addEventListener("keypress", function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        modalVerifyBtn.click();
                    }
                });
            }
        });
    });
</script>
