{% comment %}
  Phone Number Input Component with Country Code Support
  
  Usage:
    {% include "components/phone_input.html" with 
      field_id="phone" 
      field_name="phone_number"
      default_country="+63"
      show_label=True
      label_text="Phone Number"
      help_text="Enter phone number without country code"
      required=False
    %}
  
  Parameters:
    - field_id: HTML id attribute for the input (default: "phone")
    - field_name: HTML name attribute for the input (default: "phone_number")
    - default_country: Default country code (default: "+63" Philippines)
    - show_label: Show label above input (default: True)
    - label_text: Custom label text (default: "Phone Number")
    - help_text: Helper text below input (default: country-specific)
    - required: Mark field as required (default: False)
{% endcomment %}

{% with field_id=field_id|default:"phone" field_name=field_name|default:"phone_number" default_country=default_country|default:"+63" show_label=show_label|default:True label_text=label_text|default:"Phone Number" required=required|default:False %}
<div class="formGroup">
  {% if show_label %}
    <label for="{{ field_id }}">
      {{ label_text }}
      {% if required %}<span style="color: red;">*</span>{% endif %}
    </label>
  {% endif %}
  
  <div class="phoneInputWrapper">
    <span class="countryCodePrefix" id="{{ field_id }}-prefix">{{ default_country }}</span>
    <input 
      type="tel" 
      id="{{ field_id }}" 
      name="{{ field_name }}" 
      placeholder="9171234567" 
      maxlength="10"
      {% if required %}required{% endif %}
    />
  </div>
  
  <small id="{{ field_id }}-helper">{{ help_text|default:"Enter phone number without country code (max 10 digits for Philippines)" }}</small>
</div>

<style>
  .phoneInputWrapper {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0;
    overflow: hidden;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .phoneInputWrapper:hover {
    border-color: #bbb;
  }

  .phoneInputWrapper:focus-within {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
  }

  .countryCodePrefix {
    background-color: #f8f9fa;
    padding: 12px 14px;
    border-right: 1px solid #ddd;
    font-weight: 700;
    color: #2c3e50;
    white-space: nowrap;
    user-select: none;
    min-width: 50px;
    text-align: center;
  }

  .phoneInputWrapper input {
    flex: 1;
    border: none;
    padding: 12px 14px;
    margin: 0;
    font-size: 1rem;
    font-family: inherit;
  }

  .phoneInputWrapper input:focus {
    outline: none;
  }
</style>

<script>
  // Phone validation utilities
  function validatePhoneFormat(phoneNumber, maxDigits) {
    if (!phoneNumber || !phoneNumber.trim()) {
      return { valid: true, message: '' }; // Phone is optional
    }
    
    const cleanPhone = phoneNumber.replace(/\D/g, '');
    if (cleanPhone.length < 10 || cleanPhone.length > maxDigits) {
      return { 
        valid: false, 
        message: `Phone number must be 10-${maxDigits} digits. Please check the format.` 
      };
    }
    return { valid: true, message: '' };
  }

  function formatPhoneNumber(countryCode, phoneNumber) {
    if (!phoneNumber || !phoneNumber.trim() || !countryCode || !countryCode.trim()) {
      return ''; // Empty if either is missing
    }
    
    const cleanPhone = phoneNumber.replace(/\D/g, '');
    return `${countryCode}${cleanPhone}`;
  }

  // Initialize phone input component
  function initPhoneInput(fieldId = "{{ field_id }}", fieldName = "{{ field_name }}") {
    const phoneInput = document.getElementById(fieldId);
    const phonePrefix = document.getElementById(fieldId + '-prefix');
    const phoneHelper = document.getElementById(fieldId + '-helper');
    const countryCodeSelect = document.getElementById('country-code');

    if (!phoneInput) return;

    // Update phone input constraints when country code changes
    if (countryCodeSelect) {
      countryCodeSelect.addEventListener('change', function() {
        const countryCode = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const maxDigits = selectedOption.getAttribute('data-max-digits');
        const countryName = selectedOption.textContent.split('(')[0].trim();
        
        if (phonePrefix) phonePrefix.textContent = countryCode;
        if (phoneInput) phoneInput.maxLength = maxDigits;
        if (phoneHelper) {
          phoneHelper.textContent = `Enter phone number without country code (max ${maxDigits} digits for ${countryName})`;
        }
      });
    }
  }

  // Run on DOM ready
  document.addEventListener('DOMContentLoaded', function() {
    initPhoneInput("{{ field_id }}", "{{ field_name }}");
  });
</script>
{% endwith %}
