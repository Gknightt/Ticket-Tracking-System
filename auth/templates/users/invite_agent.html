{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invite Agent</title>
    <link rel="stylesheet" href="{% static 'css/profile_settings.css' %}" />
    <link rel="stylesheet" href="{% static 'css/agent_management.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      .inviteAgentPage {
        display: flex;
        min-height: 100vh;
        margin-left: 250px;
      }

      .inviteAgentContainer {
        flex: 1;
        padding: 40px;
        max-width: 1000px;
        margin: 0 auto;
        width: 100%;
      }

      .inviteHeader {
        margin-bottom: 30px;
      }

      .inviteHeader h2 {
        font-size: 2rem;
        color: #333;
        margin: 0;
      }

      .inviteForm {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .formRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .formRow.full {
        grid-template-columns: 1fr;
      }

      .formGroup {
        display: flex;
        flex-direction: column;
      }

      .formGroup label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .formGroup input,
      .formGroup select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        font-family: inherit;
      }

      .formGroup input:focus,
      .formGroup select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .formGroup small {
        font-size: 0.85rem;
        color: #666;
        margin-top: 4px;
      }

      .formActions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
      }

      .btnPrimary {
        background-color: #007bff;
        color: white;
      }

      .btnPrimary:hover {
        background-color: #0056b3;
      }

      .btnSecondary {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
      }

      .btnSecondary:hover {
        background-color: #e0e0e0;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .toastContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .toast {
        padding: 15px 20px;
        border-radius: 4px;
        min-width: 300px;
        animation: slideIn 0.3s ease-out;
      }

      .toast.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .toast.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .toast.hidden {
        display: none;
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .successMessage {
        background-color: #d4edda;
        color: #155724;
        padding: 20px;
        border-radius: 4px;
        margin-top: 20px;
        display: none;
      }

      .successMessage.show {
        display: block;
      }

      .errorAlert {
        background-color: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 4px;
        margin-top: 20px;
        display: none;
        border: 1px solid #f5c6cb;
      }

      .errorAlert.show {
        display: block;
      }

      .errorAlert h3 {
        margin: 0 0 10px 0;
        color: #721c24;
      }

      .errorAlert ul {
        margin: 10px 0 0 20px;
        padding: 0;
      }

      .errorAlert li {
        margin: 5px 0;
      }

      .toast.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .toast.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .fieldError {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
      }

      .fieldError + small {
        color: #dc3545 !important;
      }

      @media (max-width: 768px) {
        .inviteAgentPage {
          margin-left: 0;
        }

        .inviteAgentContainer {
          padding: 20px;
        }

        .formRow {
          grid-template-columns: 1fr;
        }

        .inviteForm {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    {% include "components/nav.html" %}
    <main class="inviteAgentPage">
      <div class="inviteAgentContainer">
        <div class="inviteHeader">
          <h2>Invite New Agent</h2>
        </div>

        <!-- Toast Messages -->
        <div id="toast-container" class="toastContainer"></div>

        <!-- Error Alert -->
        <div id="error-alert" class="errorAlert">
          <h3>⚠️ Error inviting agent</h3>
          <p id="error-message"></p>
          <ul id="error-details" style="display: none;"></ul>
        </div>

        <!-- Invite Form -->
        <div class="inviteForm">
          <form id="invite-form">
            <div class="formRow">
              <div class="formGroup">
                <label for="first-name">First Name</label>
                <input type="text" id="first-name" name="first_name" />
              </div>
              <div class="formGroup">
                <label for="middle-name">Middle Name</label>
                <input type="text" id="middle-name" name="middle_name" />
              </div>
            </div>

            <div class="formRow">
              <div class="formGroup">
                <label for="last-name">Last Name</label>
                <input type="text" id="last-name" name="last_name" />
              </div>
              <div class="formGroup">
                <label for="suffix">Suffix</label>
                <select id="suffix" name="suffix">
                  <option value="">---------</option>
                  <option value="Jr.">Jr.</option>
                  <option value="Sr.">Sr.</option>
                  <option value="II">II</option>
                  <option value="III">III</option>
                  <option value="IV">IV</option>
                  <option value="V">V</option>
                </select>
              </div>
            </div>

            <div class="formRow full">
              <div class="formGroup">
                <label for="email">Email <span style="color: red;">*</span></label>
                <input type="email" id="email" name="email" required />
                <small>User will receive login credentials via email</small>
              </div>
            </div>

            <div class="formRow">
              <div class="formGroup">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" name="phone_number" />
              </div>
              <div class="formGroup">
                <label for="department">Department</label>
                <select id="department" name="department">
                  <option value="">---------</option>
                  <option value="IT Department">IT Department</option>
                  <option value="Asset Department">Asset Department</option>
                  <option value="Budget Department">Budget Department</option>
                </select>
              </div>
            </div>

            <div class="formRow full">
              <div class="formGroup">
                <label for="role">Role & System <span style="color: red;">*</span></label>
                <select id="role" name="role_id" required>
                  <option value="">Select a role...</option>
                  <!-- Roles will be loaded dynamically -->
                </select>
              </div>
            </div>

            <div class="formActions">
              <a href="{% url 'agent-management' %}" class="btn btnSecondary">
                Cancel
              </a>
              <button type="submit" class="btn btnPrimary" id="submit-btn">
                Invite Agent
              </button>
            </div>
          </form>

          <!-- Success Message -->
          <div id="success-message" class="successMessage">
            <h3>Agent Invited Successfully!</h3>
            <p>Email: <strong id="success-email"></strong></p>
            <p>Temporary Password: <strong id="success-password"></strong></p>
            <p>Role: <strong id="success-role"></strong></p>
            <p>System: <strong id="success-system"></strong></p>
            <p style="margin-top: 15px; color: #a02622;"><strong>Please save this password securely.</strong></p>
          </div>
        </div>
      </div>
    </main>

    <script>
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                        getCookie('csrftoken');

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // Load roles on page load
      async function loadRoles() {
        try {
          const response = await fetch('/api/v1/roles/', {
            headers: {
              'X-CSRFToken': csrfToken,
            },
            credentials: 'include',
          });

          if (!response.ok) {
            throw new Error('Failed to load roles');
          }

          const data = await response.json();
          const roleSelect = document.getElementById('role');
          roleSelect.innerHTML = '<option value="">Select a role...</option>';

          // Handle both array and paginated response formats
          const roles = Array.isArray(data) ? data : (data.results || []);
          if (roles.length > 0) {
            roles.forEach(role => {
              const option = document.createElement('option');
              option.value = role.id;
              option.textContent = `${role.name} (${role.system_name})`;
              roleSelect.appendChild(option);
            });
          } else {
            console.warn('No roles found in response:', data);
            showToast('No roles available. Please contact an administrator.', 'warning');
          }
        } catch (error) {
          console.error('Error loading roles:', error);
          showToast('Failed to load roles. Please refresh the page.', 'error');
        }
      }

      // Show toast notification
      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <span>${message}</span>
          <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: none; border: none; color: inherit; cursor: pointer; font-weight: bold;">×</button>
        `;

        container.appendChild(toast);

        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 5000);
      }

      // Show error alert with detailed messages
      function showErrorAlert(message, details = null) {
        const errorAlert = document.getElementById('error-alert');
        const errorMsg = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');

        errorMsg.textContent = message || 'An error occurred while inviting the agent.';
        
        if (details && Array.isArray(details) && details.length > 0) {
          errorDetails.innerHTML = '';
          details.forEach(detail => {
            const li = document.createElement('li');
            li.textContent = detail;
            errorDetails.appendChild(li);
          });
          errorDetails.style.display = 'block';
        } else if (details && typeof details === 'string') {
          errorDetails.innerHTML = `<li>${details}</li>`;
          errorDetails.style.display = 'block';
        } else {
          errorDetails.style.display = 'none';
        }

        errorAlert.classList.add('show');
        errorAlert.scrollIntoView({ behavior: 'smooth' });
      }

      // Hide error alert
      function hideErrorAlert() {
        const errorAlert = document.getElementById('error-alert');
        errorAlert.classList.remove('show');
      }

      // Parse API errors into user-friendly messages
      function parseErrorResponse(errorData) {
        const details = [];
        let mainMessage = 'Failed to invite agent.';

        if (typeof errorData === 'string') {
          mainMessage = errorData;
        } else if (errorData.error) {
          mainMessage = errorData.error;
          if (typeof errorData.error === 'object') {
            Object.entries(errorData.error).forEach(([key, value]) => {
              if (Array.isArray(value)) {
                value.forEach(v => details.push(`${key}: ${v}`));
              } else {
                details.push(`${key}: ${value}`);
              }
            });
          }
        } else if (errorData.detail) {
          mainMessage = errorData.detail;
        } else if (typeof errorData === 'object') {
          Object.entries(errorData).forEach(([key, value]) => {
            if (key !== 'error' && key !== 'detail') {
              if (Array.isArray(value)) {
                value.forEach(v => details.push(`${key}: ${v}`));
              } else if (typeof value === 'object') {
                details.push(`${key}: ${JSON.stringify(value)}`);
              } else {
                details.push(`${key}: ${value}`);
              }
            }
          });
        }

        return { mainMessage, details };
      }

      // Handle specific HTTP error status codes
      async function handleErrorResponse(response) {
        const contentType = response.headers.get('content-type');
        let errorData = {};

        try {
          if (contentType && contentType.includes('application/json')) {
            errorData = await response.json();
          } else {
            const text = await response.text();
            errorData = { detail: text || 'Unknown error occurred' };
          }
        } catch (e) {
          errorData = { detail: 'Unable to parse error response' };
        }

        const { mainMessage, details } = parseErrorResponse(errorData);

        // Handle specific status codes
        switch (response.status) {
          case 400:
            return {
              message: mainMessage || 'Invalid input. Please check the form fields.',
              details: details,
              type: 'validation'
            };
          case 401:
            return {
              message: 'Your session has expired. Please refresh and try again.',
              details: [],
              type: 'auth'
            };
          case 403:
            return {
              message: 'You do not have permission to invite agents for this role/system.',
              details: [],
              type: 'permission'
            };
          case 409:
            return {
              message: 'This email is already registered in the system.',
              details: ['User already exists. Try assigning a different role or contact the user.'],
              type: 'conflict'
            };
          case 429:
            return {
              message: 'Too many requests. Please wait a moment before trying again.',
              details: [],
              type: 'rate_limit'
            };
          case 500:
          case 502:
          case 503:
            return {
              message: 'Server error. Please try again later.',
              details: ['If the problem persists, contact support.'],
              type: 'server'
            };
          default:
            return {
              message: mainMessage || `Error (${response.status}): Failed to invite agent.`,
              details: details,
              type: 'unknown'
            };
        }
      }

      // Handle form submission
      document.getElementById('invite-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Clear previous errors
        hideErrorAlert();
        document.querySelectorAll('.fieldError').forEach(field => {
          field.classList.remove('fieldError');
        });

        const formData = new FormData(this);
        const submitBtn = document.getElementById('submit-btn');
        const originalBtnText = submitBtn.textContent;
        
        // Validate required fields
        const email = formData.get('email')?.trim();
        const roleId = formData.get('role_id');

        if (!email) {
          document.getElementById('email').classList.add('fieldError');
          showErrorAlert('Email is required', ['Please enter a valid email address.']);
          submitBtn.disabled = false;
          return;
        }

        if (!roleId) {
          document.getElementById('role').classList.add('fieldError');
          showErrorAlert('Role is required', ['Please select a role and system.']);
          submitBtn.disabled = false;
          return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          document.getElementById('email').classList.add('fieldError');
          showErrorAlert('Invalid email format', ['Please enter a valid email address (e.g., user@example.com).']);
          submitBtn.disabled = false;
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Inviting...';

        try {
          const inviteData = new FormData();
          inviteData.append('email', email);
          inviteData.append('first_name', formData.get('first_name')?.trim() || '');
          inviteData.append('middle_name', formData.get('middle_name')?.trim() || '');
          inviteData.append('last_name', formData.get('last_name')?.trim() || '');
          inviteData.append('suffix', formData.get('suffix') || '');
          inviteData.append('phone_number', formData.get('phone_number')?.trim() || '');
          inviteData.append('department', formData.get('department') || '');
          inviteData.append('role_id', roleId);

          const response = await fetch('/api/v1/system-roles/invite/', {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
            },
            credentials: 'include',
            body: inviteData,
          });

          if (!response.ok) {
            const errorInfo = await handleErrorResponse(response);
            showErrorAlert(errorInfo.message, errorInfo.details || []);
            
            // Highlight email field on conflict error
            if (errorInfo.type === 'conflict') {
              document.getElementById('email').classList.add('fieldError');
            }
            
            // Log error for debugging
            console.error(`Error (${response.status}):`, errorInfo);
            showToast(errorInfo.message, 'error');
            return;
          }

          const result = await response.json();

          // Validate response structure
          if (!result.user || !result.role) {
            console.warn('Unexpected response structure:', result);
            showErrorAlert(
              'Invitation sent but response incomplete',
              ['The agent was invited but we could not display all details. Please verify the invitation.']
            );
            showToast('Agent invited successfully!', 'success');
            this.reset();
            return;
          }

          // Show success message with credentials
          document.getElementById('success-email').textContent = result.user;
          document.getElementById('success-password').textContent = result.temporary_password || 'N/A';
          document.getElementById('success-role').textContent = result.role;
          document.getElementById('success-system').textContent = result.system || 'N/A';
          document.getElementById('success-message').classList.add('show');

          if (result.temporary_password) {
            showToast(`✅ Agent invited successfully! Password: ${result.temporary_password}`, 'success');
          } else {
            showToast(`✅ Agent ${result.user} has been invited to ${result.role} role`, 'success');
          }

          // Reset form
          this.reset();
          
          // Scroll to success message
          setTimeout(() => {
            document.getElementById('success-message').scrollIntoView({ behavior: 'smooth' });
          }, 300);

        } catch (error) {
          console.error('Request error:', error);
          
          // Handle network errors
          if (error instanceof TypeError) {
            showErrorAlert(
              'Network error',
              ['Unable to reach the server. Please check your connection and try again.']
            );
            showToast('Network error: ' + error.message, 'error');
          } else {
            showErrorAlert(
              'An unexpected error occurred',
              [error.message || 'Please try again or contact support.']
            );
            showToast(error.message || 'Failed to invite agent', 'error');
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        }
      });

      // Initialize page
      document.addEventListener('DOMContentLoaded', function() {
        loadRoles();
      });
    </script>
  </body>
</html>
